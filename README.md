# BCLiquorBot
## Introduction  
BCLiquorBot is a serverless app built for slack that finds the best value drinks from BC liquor stores. It supports search terms, price filtering, and store stock information. See the following demo.
<img src="https://user-images.githubusercontent.com/16991582/163689647-1f4abef0-9985-43c3-b9ee-814eb4c8c6a7.gif" width="700" />

Finds the optimal drinks for you to buy based on weights you specify (default is 90% value 10% reviews with up to 20% boost for big sales). Runs completely on AWS lambda/dynamoDB free tier and integrates with slack's modals.

## Installing
1. Create 3 lambda functions, first refreshes the cache, second searches said cache when a user submits a request, third acts as the slack middleman and manages modals (```cache.py```, ```dbSearch.py```, and ```slackHandler.py``` respectively)
2. Create a new layer with requests, add it to all 3 functions
3. Create a slack app, subscribe to users opening your homepage and enable interactivity. Link it to function #3 (slack middleman)
4. Create a global action for the app (optional)
5. Create a dynamodb instance with a table for products, give permission to the cache and search functions
6. Create the appropriate environment variables for each function (below)
7. Schedule the cache updater to run every 2 or so hours
8. Set cache lambda timeout to 15 mins
9. Give slack middleman permission to invoke searchDB
10. For faster results (while still staying under the free tier limits) up the memory of the database search function to 448MB

### Env Variables
#### Cache

| Key           |        Value         |
| ------------- | :------------------: |
| PRODUCT_TABLE | *product table name* |

#### Search
| Key                          |                                                                                                                          Value                                                                                                                           |
| ---------------------------- | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------: |
| PRODUCT_TABLE                |                                                                                                                   *product table name*                                                                                                                   |
| BOT_TOKEN                    |                                                                                                                    *slack bot token*                                                                                                                     |
| DIVIDER_TEMPLATE             |                                                                                                                   {"type": "divider"}                                                                                                                    |
| MODAL_DRINK_CARD_TEMPLATE    |                                                                                          {"type": "section","text": {"type": "mrkdwn","text": "*<{liquor_link}                                                                                           | {drink_name}>*\n_({volume})_ {alcPerc}%\nScore: *{score}*/100\n*_${price}_* (with tax){sale}\nRaw Value: *{value}*\n{rating}"},"accessory": {"type": "image","image_url": "{image_url}","alt_text": "alcohol, probably"}} |
| MODAL_LOCATION_CARD_TEMPLATE | {"type": "context","elements": [{"type": "image","image_url": "https://api.slack.com/img/blocks/bkb_template_images/tripAgentLocationMarker.png","alt_text": "Location Pin Icon"},{"type": "plain_text","emoji": true,"text": "Location: {locations}"}]} |
| NOT_FOUND_IMAGE              |                                                                                         https://netflixroulette.files.wordpress.com/2013/01/image-not-found.gif                                                                                                                        
| PRODUCT_URL_BASE             |                                                                                                          http://www.bcliquorstores.com/product/                                                                                                          |
| RETURN_MODAL_TEMPLATE        |            {"text":"Search Complete!","blocks": [{"type": "section","text": {"type": "mrkdwn","text": "Here are the top *N* results"}}]}                                                               |
| RETURN_NO_RESULTS            |                                                              {"type":"context","elements": [{"type": "mrkdwn","text": "Sorry, there are no results that match your search :( Please try again with a modified search!"}]}                                                            |
| STORE_NAME_MAP               |                                           {"218": "FORT","178":"FAIRFIELD","82":"HILLSIDE","161":"BLANSHARD","140":"CEDAR HILL","150":"JAMES BAY","242":"SAANICH","124":"GORGE & TILLICUM","181":"BROADMEAD"}                                            |
| TOP_N_RESULTS                |                                                                                                                            5                                                                                                                             |

#### Slack middleman
| Key                 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             Value                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| ------------------- | :-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------: |
| BOT_TOKEN           |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       *slack bot token*                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| HOME_PAGE           |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    [{"type": "section","text": {"type": "mrkdwn","text": " "},"accessory": {"type": "button","text": {"type": "plain_text","text": "Find Liquor","emoji": true},"value": "find_liquor"}}]                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| MODAL               | {"type": "modal","title": {"type": "plain_text","text": "Liquor Bot","emoji": true},"submit": {"type": "plain_text","text": "Submit","emoji": true},"close": {"type": "plain_text","text": "Cancel","emoji": true},"blocks": [{"type": "input","block_id": "search","element": {"type": "plain_text_input","action_id": "query","placeholder": {"type": "plain_text","text": "all, beer, gin, vodka, etc"}},"label": {"type": "plain_text","text": "Search"}},{"type": "input","block_id": "stores","element": {"type": "multi_static_select","action_id": "selected_stores","options": [{"text": {"type": "plain_text","text": "FORT - Oak Bay high"},"value": "218"},{"text": {"type": "plain_text","text": "FAIRFIELD - Fairfield Plaza"},"value": "178"},{"text": {"type": "plain_text","text": "HILLSIDE - Hillside Mall"},"value": "82"},{"text": {"type": "plain_text","text": "BLANSHARD SQUARE - 787 Hillside Ave"},"value": "161"},{"text": {"type": "plain_text","text": "CEDAR HILL - 3611 Shelbourne St"},"value": "140"},{"text": {"type": "plain_text","text": "JAMES BAY - 101-225 Menzies St"},"value": "150"},{"text": {"type": "plain_text","text": "SAANICH - 1087 Mckenzie Ave"},"value": "242"},{"text": {"type": "plain_text","text": "GORGE & TILLICUM - 2955 Tillicum Rd"},"value": "124"},{"text": {"type": "plain_text","text": "BROADMEAD VILLAGE - 370 777 Royal Oak Dr"},"value": "181"}]},"label": {"type": "plain_text","text": "Stores","emoji": true}},{"type": "input","block_id": "max_price","element": {"type": "plain_text_input","action_id": "max_price","initial_value": "0"},"label": {"type": "plain_text","text": "Max Price (including tax)"}},{"type": "section","text": {"type": "mrkdwn","text": " "}},{"block_id": "channel_select","type": "input","optional": false,"label": {"type": "plain_text","text": "Select a channel to post the result on"},"element": {"action_id": "selected_channel","type": "conversations_select","default_to_current_conversation": true, "response_url_enabled": true}}]} |
| SEARCH_FUNCTION_ARN |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     *search function ARN*                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
